#include <stdint.h>
#include "stdio.h"

#define CONST_PLANT 1976  //-2^32 mod q
#define Q 3329
#define Qinv_Plant 1806234369

// Multiplication by a constant, where b is pre-multiplied by Qinv_Plant.
int16_t plant_mul(int32_t a, int32_t b){
  int32_t t;
  t=(int32_t)a*b;
  t>>=16;
  t=(t+8)*Q;
  t>>=16;
  return t;
}

int16_t plant_red(int32_t a){
  int32_t t;
  t=(int32_t)a*Qinv_Plant;
  t>>=16;
  t=(t+8)*Q;
  t>>=16;
  return t;
}


const uint32_t zetas_plantard_cpu[128] = {
        0,2230699446, 3328631909, 4243360600 ,3408622288 ,812805467, 2447447570, 1094061961 ,1370157786, 2475831253, 249002310 ,
        1028263423, 3594406395 ,4205945745 ,734105255, 2252632292, 381889553, 3157039644 ,1727534158, 1904287092, 3929849920 ,72249375,
        2889974991 ,1719793153, 1839778722, 2701610550 ,690239563, 3718262466 ,3087370604, 3714391964, 2546790461 ,1059227441,
        372858381, 427045412 ,4196914574 ,2265533966 ,1544330386, 2972545705, 2937711185, 2651294021, 838608815, 2550660963, 3242190693,
        815385801 ,3696329620, 42575525, 1703020977 ,2470670584, 2991898216, 1851390229 ,1041165097 ,583155668, 1855260731 ,3700200122,
        1979116802, 3098982111 ,3415073125 ,3376368103 ,1910737929 ,836028480 ,3191874164 ,4012420634 ,1583035408 ,1174052340 ,
        21932846 ,3562152210, 752167598 ,3417653460, 2112004045, 932791035, 2951903026, 1419184148, 1817845876 ,3434425636,
        4233039261 ,300609006 ,975366560, 2781600929 ,3889854731, 3935010590, 2197155094, 2130066389, 3598276897, 2308109491, 2382939200,
        1228239371, 1884934581, 3466679822 ,1211467195 ,2977706375, 3144137970, 3080919767, 945692709, 3015121229, 345764865, 826997308,
        2043625172 ,2964804700 ,2628071007, 4154339049 ,483812778, 3288636719, 2696449880 ,2122325384, 1371447954, 411563403 ,3577634219,
        976656727 ,2708061387, 723783916 ,3181552825, 3346694253, 3617629408, 1408862808, 519937465 ,1323711759 ,1474661346 ,2773859924 ,
        3580214553, 1143088323, 2221668274, 1563682897, 2417773720 ,1327582262, 2722253228 ,3786641338 ,1141798155 ,2779020594
};

const uint32_t zetas_inv_plantard_cpu[128]={
          1515946703, 3153169142, 508325959, 1572714069, 2967385035 ,1877193577, 2731284400, 2073299023 ,3151878974,
          714752744, 1521107373, 2820305951 ,2971255538 ,3775029832 ,2886104489 ,677337889 ,948273044 ,1113414472 ,
          3571183381, 1586905910 ,3318310570, 717333078 ,3883403894, 2923519343 ,2172641913, 1598517417, 1006330578,
          3811154519, 140628248 ,1666896290, 1330162597 ,2251342125, 3467969989, 3949202432, 1279846068 ,3349274588,
          1214047530, 1150829327, 1317260922, 3083500102 ,828287475 ,2410032716, 3066727926 ,1912028097, 1986857806,
          696690400, 2164900908, 2097812203, 359956707, 405112566 ,1513366368, 3319600737 ,3994358291, 61928036,
          860541661 ,2477121421 ,2875783149 ,1343064271, 3362176262 ,2182963252, 877313837, 3542799699 ,732815087,
          4273034451 ,3120914957 ,2711931889, 282546663, 1103093133,3458938817, 2384229368, 918599194 ,879894172 ,
          1195985186, 2315850495 ,594767175 ,2439706566 ,3711811629 ,3253802200 ,2443577068 ,1303069081 ,1824296713 ,
          2591946320 ,4252391772, 598637677, 3479581496, 1052776604, 1744306334 ,3456358482, 1643673276, 1357256112 ,
          1322421592 ,2750636911 ,2029433331, 98052723 ,3867921885 ,3922108916,3235739856, 1748176836 , 580575333,1207596693, 
          576704831 ,3604727734 ,1593356747, 2455188575, 2575174144 ,1404992306,  4222717922, 365117377 ,2390680205, 2567433139, 
          1137927653, 3913077744 ,2042335005 , 3560862042 ,89021552 , 700560902 , 3266703874 , 4045964987 ,  1819136044 , 2924809511, 
          3200905336 ,1847519727 ,3482161830 ,886345009, 51606697, 966335388 , 2064267851, 2435836064        
};

void ntt(int16_t r[256]) {
  unsigned int len, start, j, k;
  int16_t t;
  uint32_t zeta;

  k = 1;
 
  for(len = 128; len>=2; len >>= 1) {     
    for(start = 0; start < 256; start = j + len) {
      zeta = zetas_plantard_cpu[k++];
      for(j = start; j < start + len; ++j) {
        t = plant_mul(r[j + len],zeta); 
        r[j + len] = r[j] - t;
        r[j] = r[j] + t;
      }
    }
  }
}

void basemul(int16_t r[2],int16_t a[2],int16_t b[2],uint32_t zeta){
  r[0]  = plant_red(a[1]*b[1]);
  r[0]  = plant_mul(r[0],zeta);
  r[0] += plant_red(a[0]*b[0]);

  r[1]  = plant_red(a[0]*b[1]);
  r[1] += plant_red(a[1]*b[0]);
}

void pointwise_multiplication(int16_t *c, int16_t *a, int16_t *b){
  for(int i=0;i<256/4;i++){
    basemul(c+4*i, a+4*i, b+4*i, zetas_plantard_cpu[64+i]);
    basemul(c+4*i+2, a+4*i+2, b+4*i+2 ,-zetas_plantard_cpu[64+i]);
  }
}

void invntt(int16_t r[256]) {
  unsigned int start, len, j, k;
  int16_t t;
  uint32_t zeta;
  k = 0;
  for(len = 2; len <= 128; len <<= 1) {
    for(start = 0; start < 256; start = j + len) {
      zeta = zetas_inv_plantard_cpu[k++];
      for(j = start; j < start + len; ++j) {
        t = r[j];
        r[j] = plant_red((int32_t)((t + r[j + len]) * CONST_PLANT));
        r[j + len] = t - r[j + len];
        r[j + len] = plant_mul(r[j + len],zeta);
      }
    }
  }
  for(j = 0; j < 256; ++j){
    r[j] = plant_mul(r[j],zetas_inv_plantard_cpu[127]);
  }
}

void print_array(int16_t *a){
  for(int i=0;i<256;i++){
    printf("%d, ", (int32_t)a[i]);
  }
  printf("\n");
}

int main(){
  int16_t a[256]={0},b[256]={0},c[256]={0};
  b[0]=1;
  for(int i=0;i<256;i++){
    a[i]=i;
  }
  print_array(a);
  print_array(b);
  ntt(a);
  ntt(b);
  print_array(a);
  print_array(b);
  pointwise_multiplication(c,a,b);
  print_array(c);
  invntt(c);
  print_array(c);
  return 0;
}